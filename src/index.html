<!DOCTYPE html>
<html>
  <head>
    <title>Mini Tower Defense</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b0f1a" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        background-color: #0b0f1a;
        color: white;
        font-family: "Arial", sans-serif;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      /* Main menu */
      #mainMenu {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        text-align: center;
        padding: 20px;
      }
      #mainMenu h1 {
        font-size: clamp(2.5em, 8vw, 4em);
        margin-bottom: 20px;
      }
      .menu-button {
        background-color: #2a3a63;
        border: 2px solid #5c7bfa;
        color: white;
        padding: 15px 32px;
        font-size: 1.2em;
        margin: 10px 2px;
        width: 200px;
        max-width: 90%;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .menu-button:hover {
        background-color: #3e528e;
      }

      /* Level selection */
      #levelSelection {
        display: none;
        width: 100%;
        height: 100%;
        padding: 20px;
        grid-auto-rows: minmax(80px, auto);
        gap: 15px;
        overflow-y: auto;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      }
      .level-button {
        background-color: #2a3a63;
        border: 2px solid #5c7bfa;
        color: white;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1/1;
      }
      .level-button.locked {
        background-color: #1c2541;
        border-color: #3a506b;
        color: #6b7b9e;
        cursor: not-allowed;
      }

      /* Canvas */
      canvas#game {
        display: none;
        width: 100%;
        height: 100%;
        touch-action: none;
        background: transparent;
      }

      /* Loading */
      #loadingScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 20px;
        z-index: 200;
        font-size: 2.5em;
        font-weight: bold;
      }
      #loadingScreen.hidden {
        display: none;
      }
      .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #5c7bfa;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Shop */
      #shopScreen {
        display: none;
        flex-direction: column;
        width: 100%;
        height: 100%;
        padding: 20px;
        position: absolute;
        top: 0;
        left: 0;
        background-color: #0b0f1a;
        z-index: 300;
      }
      #shopHeader {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 2px solid #2a3a63;
      }
      #shopHeader h2 {
        font-size: 2em;
        margin-bottom: 10px;
      }
      #shopMoneyBalance {
        font-weight: bold;
        color: #ffd700;
      }
      #towerList {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px 5px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
      }
      .shop-item {
        background-color: #1c2541;
        border: 1px solid #3a506b;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .shop-item h3 {
        color: #5c7bfa;
        margin-bottom: 10px;
      }
      .shop-item p {
        margin-bottom: 15px;
      }
      .shop-item button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
      }

      /* In-game menu */
      #inGameMenuBtn {
        display: none;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 800;
        background: rgba(30, 40, 60, 0.95);
        color: #fff;
        border: 1px solid #5c7bfa;
        padding: 8px 10px;
        border-radius: 6px;
        font-weight: 600;
        touch-action: manipulation;
        backdrop-filter: blur(4px);
      }
      #pauseOverlay {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 900;
        background: rgba(3, 6, 12, 0.65);
        backdrop-filter: blur(4px);
      }
      #pausePanel {
        width: 320px;
        max-width: 90%;
        background: linear-gradient(180deg, #121428, #161a2e);
        border: 1px solid rgba(92, 123, 250, 0.18);
        padding: 18px;
        border-radius: 12px;
        text-align: center;
      }
      .pause-btn {
        display: block;
        margin: 12px auto;
        width: 80%;
        padding: 10px 14px;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
        background: #2a3a63;
        color: white;
      }

      /* Confirm modal for main menu */
      #confirmModal {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.7);
      }
      #confirmBox {
        width: 360px;
        max-width: 94%;
        background: #111421;
        border-radius: 12px;
        padding: 18px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .confirm-title {
        font-size: 1.25rem;
        margin-bottom: 8px;
      }
      .confirm-body {
        color: #cfe6ff;
        margin-bottom: 18px;
      }
      .confirm-row {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .confirm-btn {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        min-width: 120px;
      }
      .confirm-cancel {
        background: #2a3a63;
        color: white;
      }
      .confirm-ok {
        background: #d9534f;
        color: white;
      }

      @media (max-width: 480px) {
        #pausePanel {
          width: 90%;
        }
        .menu-button {
          width: 90%;
          padding: 12px 18px;
        }
      }
    </style>
  </head>

  <body>
    <!-- MAIN MENU -->
    <div id="mainMenu" aria-hidden="false">
      <h1>Mini Tower Defense</h1>
      <button id="startButton" class="menu-button">Start</button>
      <button id="shopButton" class="menu-button">Shop</button>
      <button id="exitButton" class="menu-button">Exit</button>
    </div>

    <!-- LEVEL SELECTION -->
    <div id="levelSelection" aria-hidden="true"></div>

    <!-- SHOP -->
    <div id="shopScreen" aria-hidden="true">
      <div id="shopHeader">
        <h2>Persistent Upgrades</h2>
        <p>Shop Money: <span id="shopMoneyBalance">0</span></p>
      </div>
      <div id="towerList" role="list"></div>
      <button
        id="backToMenuButton"
        class="menu-button"
        style="margin: 20px auto 0"
      >
        Back
      </button>
    </div>

    <!-- GAME CANVAS -->
    <canvas
      id="game"
      width="1280"
      height="720"
      aria-label="Game canvas"
    ></canvas>

    <!-- IN-GAME MENU -->
    <button id="inGameMenuBtn" aria-label="Open menu">â˜°</button>
    <div id="pauseOverlay" aria-hidden="true">
      <div id="pausePanel" role="dialog" aria-label="Game menu">
        <h2 style="margin-bottom: 8px">Paused</h2>
        <button id="pauseResumeBtn" class="pause-btn">Resume</button>
        <!-- Shop removed from in-game/pause menu -->
        <button id="pauseMainBtn" class="pause-btn">Main Menu</button>
      </div>
    </div>

    <!-- Confirm modal (Main menu) -->
    <div id="confirmModal" aria-hidden="true">
      <div
        id="confirmBox"
        role="dialog"
        aria-labelledby="confirmTitle"
        aria-describedby="confirmDesc"
      >
        <div id="confirmTitle" class="confirm-title">Warning!</div>
        <div id="confirmDesc" class="confirm-body">Return to Main Menu?</div>
        <div class="confirm-row">
          <button id="confirmCancel" class="confirm-btn confirm-cancel">
            Cancel
          </button>
          <button id="confirmOk" class="confirm-btn confirm-ok">
            Yes, Exit
          </button>
        </div>
      </div>
    </div>

    <!-- LOADING -->
    <div id="loadingScreen" class="hidden" aria-hidden="true">
      <div class="spinner" role="status" aria-hidden="true"></div>
      <span>Loading...</span>
    </div>

    <script type="module">
      import { startGame } from "./index.mjs";
      import { levels } from "./levels.js";
      import { TOWER_TYPES } from "./config.js";

      // ---------- persistent player data ----------
      const playerData = {};
      function loadPlayerData() {
        const raw = localStorage.getItem("towerDefensePlayerData");
        const saved = raw ? JSON.parse(raw) : null;
        const defaultData = {
          shopMoney: 11123500,
          unlockedTowers: ["gun"],
          persistentCurrentLevel: { gun: 1 },
        };
        Object.assign(playerData, defaultData, saved || {});
        if (saved) {
          if (
            saved.persistentCurrentLevel &&
            typeof saved.persistentCurrentLevel === "object"
          ) {
            playerData.persistentCurrentLevel = Object.assign(
              {},
              defaultData.persistentCurrentLevel,
              saved.persistentCurrentLevel
            );
          } else {
            if (saved.towerLevels && typeof saved.towerLevels === "object") {
              playerData.persistentCurrentLevel = Object.assign(
                {},
                defaultData.persistentCurrentLevel,
                saved.towerLevels
              );
            }
            if (
              saved.persistentMaxLevel &&
              typeof saved.persistentMaxLevel === "object"
            ) {
              playerData.persistentCurrentLevel = Object.assign(
                {},
                playerData.persistentCurrentLevel || {},
                saved.persistentMaxLevel
              );
            }
          }
        }
        if (TOWER_TYPES) {
          Object.keys(TOWER_TYPES).forEach((key) => {
            if (typeof playerData.persistentCurrentLevel[key] === "undefined") {
              playerData.persistentCurrentLevel[key] =
                playerData.unlockedTowers &&
                playerData.unlockedTowers.includes(key)
                  ? 1
                  : 0;
            }
          });
        }
        playerData.towerLevels = playerData.persistentCurrentLevel;
        window.playerData = playerData;
      }
      function savePlayerData() {
        const toSave = Object.assign({}, playerData);
        delete toSave.towerLevels;
        localStorage.setItem("towerDefensePlayerData", JSON.stringify(toSave));
      }

      // ---------- DOM refs ----------
      const mainMenu = document.getElementById("mainMenu");
      const levelSelection = document.getElementById("levelSelection");
      const startButton = document.getElementById("startButton");
      const shopButton = document.getElementById("shopButton");
      const exitButton = document.getElementById("exitButton");
      const shopScreen = document.getElementById("shopScreen");
      const backToMenuButton = document.getElementById("backToMenuButton");
      const towerList = document.getElementById("towerList");
      const shopMoneyBalance = document.getElementById("shopMoneyBalance");
      const loadingScreen = document.getElementById("loadingScreen");
      const gameCanvas = document.getElementById("game");
      const inGameMenuBtn = document.getElementById("inGameMenuBtn");
      const pauseOverlay = document.getElementById("pauseOverlay");
      const pauseResumeBtn = document.getElementById("pauseResumeBtn");
      const pauseMainBtn = document.getElementById("pauseMainBtn");
      const confirmModal = document.getElementById("confirmModal");
      const confirmCancel = document.getElementById("confirmCancel");
      const confirmOk = document.getElementById("confirmOk");

      // helper: safely set visible & aria-hidden; blur active element inside when hiding
      // ---------- Replace the old setVisibility and related helpers with this ----------

      // Helper: when showing, explicitly set a display type appropriate for the element.
      // When hiding, blur any focused child to avoid aria-hidden warnings.
      function setVisibility(el, visible, forcedDisplay) {
        if (!el) return;
        if (!visible) {
          try {
            const active = document.activeElement;
            if (active && el.contains(active)) active.blur();
          } catch (err) {
            /* ignore */
          }
          el.style.display = "none";
          el.setAttribute("aria-hidden", "true");
          return;
        }

        // If a forcedDisplay value is provided, use it.
        if (forcedDisplay) {
          el.style.display = forcedDisplay;
          el.setAttribute("aria-hidden", "false");
          return;
        }

        // Try to detect a sensible display value:
        // - If element already had a computed display other than 'none', use it.
        // - Otherwise, pick defaults for known elements.
        const cs = window.getComputedStyle(el);
        if (cs && cs.display && cs.display !== "none") {
          el.style.display = cs.display;
          el.setAttribute("aria-hidden", "false");
          return;
        }

        // Fallback map for elements that are initially hidden by CSS
        const fallback = (() => {
          if (el.id === "levelSelection") return "grid";
          if (el.id === "shopScreen") return "flex";
          if (el.id === "mainMenu") return "flex";
          if (el.id === "pauseOverlay") return "flex";
          if (el.id === "confirmModal") return "flex";
          if (el.tagName && el.tagName.toLowerCase() === "canvas")
            return "block";
          // Generic fallback:
          return "block";
        })();

        el.style.display = fallback;
        el.setAttribute("aria-hidden", "false");
      }

      // ---------- Replace showLevelSelection / startLevel / shop show/hide ----------

      function showLevelSelection(e) {
        if (e) e.preventDefault();
        // hide main menu and display the grid explicitly
        setVisibility(mainMenu, false);
        setVisibility(levelSelection, true, "grid");

        const highestUnlockedLevel = parseInt(
          localStorage.getItem("towerDefenseHighestLevel") || "1"
        );
        levelSelection.innerHTML = "";

        for (const lvl of levels) {
          const levelButton = document.createElement("button");
          levelButton.textContent = `${lvl.level}`;
          levelButton.className = "level-button";

          if (lvl.level > highestUnlockedLevel) {
            levelButton.classList.add("locked");
            levelButton.disabled = true;
          } else {
            levelButton.addEventListener("click", () => startLevel(lvl.level));
          }
          levelSelection.appendChild(levelButton);
        }

        // Focus first unlocked level for accessibility
        const firstBtn = levelSelection.querySelector(
          ".level-button:not(.locked)"
        );
        if (firstBtn) firstBtn.focus();
      }

      async function startLevel(levelNumber) {
        // hide selection, show canvas and the in-game menu button
        setVisibility(levelSelection, false);
        setVisibility(mainMenu, false);
        setVisibility(loadingScreen, true, "flex");
        // show the canvas explicitly
        setVisibility(gameCanvas, true, "block");
        inGameMenuBtn.style.display = "block";

        try {
          window.playerData = playerData; // ensure index.mjs sees the player data object
          await startGame(levelNumber);
          window.dispatchEvent(
            new CustomEvent("game-started", { detail: { level: levelNumber } })
          );
        } catch (err) {
          console.error("Error starting game:", err);
          // fallback UI if level load fails
          setVisibility(gameCanvas, false);
          inGameMenuBtn.style.display = "none";
          alert("Failed to load level. Please try again.");
          showLevelSelection();
        } finally {
          setVisibility(loadingScreen, false);
        }
      }

      function showShopScreen() {
        // Shop is accessible only from the main menu. Show shop screen and render contents.
        setVisibility(shopScreen, true, "flex");
        renderShop();
      }

      function hideShopScreen() {
        setVisibility(shopScreen, false);
        if (gameCanvas.style.display === "block") {
          // In-game (shouldn't happen since shop isn't available while playing) keep in-game menu visible
          inGameMenuBtn.style.display = "block";
        } else {
          // Not in-game: return to main menu
          setVisibility(mainMenu, true, "flex");
        }
      }

      // ---------- shop rendering ----------
      function renderShop() {
        shopMoneyBalance.textContent = playerData.shopMoney;
        towerList.innerHTML = "";
        for (const key in TOWER_TYPES) {
          const towerConfig = TOWER_TYPES[key];
          const isUnlocked = (playerData.unlockedTowers || []).includes(key);
          const currentLevel = playerData.persistentCurrentLevel[key] || 0;
          const maxLevel =
            towerConfig.maxLevel || towerConfig.persistentMaxLevel || 1;
          const towerDiv = document.createElement("div");
          towerDiv.className = "shop-item";
          let statusText = isUnlocked
            ? `Level ${Math.max(1, currentLevel)} / ${maxLevel}`
            : "Locked";
          if (isUnlocked && currentLevel >= maxLevel)
            statusText = `Level ${maxLevel} / Max`;
          let actionButtonHTML = "";
          if (!isUnlocked) {
            const canAfford =
              playerData.shopMoney >= (towerConfig.unlockPrice || Infinity);
            actionButtonHTML = `<button class="unlock-btn" data-key="${key}" ${
              !canAfford ? "disabled" : ""
            }>Unlock ($${towerConfig.unlockPrice || 0})</button>`;
          } else if (currentLevel < maxLevel) {
            const upgradeBase = Math.max(1, currentLevel);
            const upgradeCost =
              (towerConfig.upgradePriceBase || 0) * upgradeBase;
            const canAfford = playerData.shopMoney >= upgradeCost;
            actionButtonHTML = `<button class="upgrade-btn" data-key="${key}" ${
              !canAfford ? "disabled" : ""
            }>Upgrade ($${upgradeCost})</button>`;
          } else {
            actionButtonHTML = `<button disabled>Max Level</button>`;
          }
          towerDiv.innerHTML = `<h3>${
            towerConfig.name || key
          }</h3><p>Status: ${statusText}</p>${actionButtonHTML}`;
          towerList.appendChild(towerDiv);
        }
      }

      towerList.addEventListener("click", (e) => {
        const key = e.target.dataset.key;
        if (!key) return;
        const towerConfig = TOWER_TYPES[key];
        if (e.target.classList.contains("unlock-btn")) {
          const cost = towerConfig.unlockPrice || 0;
          if (playerData.shopMoney >= cost) {
            playerData.shopMoney -= cost;
            playerData.unlockedTowers = playerData.unlockedTowers || [];
            if (!playerData.unlockedTowers.includes(key))
              playerData.unlockedTowers.push(key);
            playerData.persistentCurrentLevel =
              playerData.persistentCurrentLevel || {};
            playerData.persistentCurrentLevel[key] = Math.max(
              1,
              playerData.persistentCurrentLevel[key] || 1
            );
            playerData.towerLevels = playerData.persistentCurrentLevel;
            savePlayerData();
            renderShop();
          }
        } else if (e.target.classList.contains("upgrade-btn")) {
          const currentLevel = playerData.persistentCurrentLevel[key] || 1;
          const maxLevel =
            towerConfig.maxLevel || towerConfig.persistentMaxLevel || Infinity;
          const upgradeBase = Math.max(1, currentLevel);
          const upgradeCost = (towerConfig.upgradePriceBase || 0) * upgradeBase;
          if (playerData.shopMoney >= upgradeCost && currentLevel < maxLevel) {
            playerData.shopMoney -= upgradeCost;
            playerData.persistentCurrentLevel[key] = currentLevel + 1;
            if (playerData.persistentCurrentLevel[key] > maxLevel)
              playerData.persistentCurrentLevel[key] = maxLevel;
            playerData.towerLevels = playerData.persistentCurrentLevel;
            savePlayerData();
            renderShop();
          }
        }
      });

      // ---------- in-game menu wiring ----------
      function showPauseOverlay() {
        setVisibility(pauseOverlay, true);
      }
      function hidePauseOverlay() {
        setVisibility(pauseOverlay, false);
      }

      // When the in-game menu button is clicked, show overlay and tell the game to pause.
      inGameMenuBtn.addEventListener("click", () => {
        showPauseOverlay();
        // Notify index.mjs to pause/autosave; it should listen to this event
        window.dispatchEvent(
          new CustomEvent("game-pause-request", {
            detail: { reason: "menu-open" },
          })
        );
      });

      pauseResumeBtn.addEventListener("click", () => {
        hidePauseOverlay();
        window.dispatchEvent(
          new CustomEvent("game-resume-request", {
            detail: { reason: "menu-resume" },
          })
        );
      });

      // When clicking main menu from pause, show confirm modal (no native alert)
      pauseMainBtn.addEventListener("click", () => {
        // hide pause overlay and show confirm modal
        hidePauseOverlay();
        setVisibility(confirmModal, true);
      });

      // Confirm modal handlers
      confirmCancel.addEventListener("click", () => {
        // close confirm and return to pause overlay
        setVisibility(confirmModal, false);
        showPauseOverlay();
      });

      confirmOk.addEventListener("click", () => {
        // user confirmed returning to main menu
        setVisibility(confirmModal, false);
        // notify index.mjs that we want main menu behavior (e.g. autosave & stop)
        window.dispatchEvent(new CustomEvent("game-mainmenu-request", {}));
        // show main menu UI locally
        showMainMenu();
      });

      // keyboard: Escape opens pause only if in-game
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (gameCanvas.style.display === "block") {
            showPauseOverlay();
            window.dispatchEvent(
              new CustomEvent("game-pause-request", {
                detail: { reason: "escape" },
              })
            );
          }
        }
      });

      // ---------- main menu visibility helper ----------
      function showMainMenu() {
        try {
          // hide overlays and show main menu; hide in-game UI
          setVisibility(confirmModal, false);
          setVisibility(pauseOverlay, false);
          setVisibility(shopScreen, false);
          setVisibility(levelSelection, false);
          gameCanvas.style.display = "none";
          inGameMenuBtn.style.display = "none";
          setVisibility(mainMenu, true);

          // notify the game that we returned to main menu (if index.mjs wants to stop loop or clean up)
          window.dispatchEvent(new CustomEvent("returned-to-mainmenu", {}));
        } catch (err) {
          console.warn("showMainMenu error", err);
          window.location.reload();
        }
      }

      // ---------- UI button hookups ----------
      startButton.addEventListener("click", showLevelSelection);
      shopButton.addEventListener("click", () => {
        // open shop from main menu context
        showShopScreen();
        setVisibility(mainMenu, false);
      });

      // Consolidated backToMenu handler (only used when shop opened from main menu)
      backToMenuButton.addEventListener("click", () => {
        hideShopScreen();
        setVisibility(mainMenu, true);
      });

      exitButton.addEventListener("click", () => {
        // exit from main menu - we can show confirm modal too (consistent behavior)
        setVisibility(confirmModal, true);
      });

      // ---------- load data ----------
      loadPlayerData();
      window.playerData = playerData;

      // expose some functions for index.mjs if it wants to control UI
      window.showMainMenu = showMainMenu;
      window.showShopScreen = () => {
        showShopScreen();
      };
      window.hideShopScreen = hideShopScreen;

      // Accessibility & tuning: blur any focused element when hiding level selection (prevents aria-hidden error)
      // We already call blur inside setVisibility when hiding.
    </script>
  </body>
</html>
