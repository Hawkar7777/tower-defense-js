<!DOCTYPE html>
<html>
  <head>
    <title>Mini Tower Defense</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b0f1a" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        background-color: #0b0f1a;
        color: white;
        font-family: "Arial", sans-serif;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #mainMenu {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        text-align: center;
        padding: 20px;
      }
      #mainMenu h1 {
        font-size: clamp(2.5em, 8vw, 4em);
        margin-bottom: 20px;
      }
      .menu-button {
        background-color: #2a3a63;
        border: 2px solid #5c7bfa;
        color: white;
        padding: 15px 32px;
        text-decoration: none;
        font-size: 1.2em;
        margin: 10px 2px;
        width: 200px;
        max-width: 90%;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .menu-button:hover {
        background-color: #3e528e;
      }
      #levelSelection {
        display: none;
        width: 100%;
        height: 100%;
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 15px;
        overflow-y: auto;
      }
      .level-button {
        background-color: #2a3a63;
        border: 2px solid #5c7bfa;
        color: white;
        text-decoration: none;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1 / 1;
      }
      .level-button:hover {
        background-color: #3e528e;
      }
      .level-button.locked {
        background-color: #1c2541;
        border-color: #3a506b;
        color: #6b7b9e;
        cursor: not-allowed;
      }
      .level-button.locked:hover {
        background-color: #1c2541;
      }
      canvas#game {
        display: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="mainMenu">
      <h1>Mini Tower Defense</h1>
      <button id="startButton" class="menu-button">Start</button>
      <button id="exitButton" class="menu-button">Exit</button>
    </div>
    <div id="levelSelection"></div>
  </body>

  <script type="module">
    import { startGame } from "./index.mjs";
    import { levels } from "./levels.js";

    // --- NEW: Global Touch Debugger ---
    // This will log ANY touch event on the page, telling us what was touched first.
    window.addEventListener("touchstart", function (event) {}, true); // 'true' makes it fire early, which is good for debugging

    const mainMenu = document.getElementById("mainMenu");
    const levelSelection = document.getElementById("levelSelection");
    const startButton = document.getElementById("startButton");
    const exitButton = document.getElementById("exitButton");

    // Check if the buttons were found

    const showLevelSelection = (e) => {
      // Prevent other events from firing, like a "click" after a "touch"
      if (e) e.preventDefault();

      mainMenu.style.display = "none";
      levelSelection.style.display = "grid";

      const highestUnlockedLevel = parseInt(
        localStorage.getItem("towerDefenseHighestLevel") || "1"
      );
      levelSelection.innerHTML = "";

      for (const level of levels) {
        const levelButton = document.createElement("button");
        levelButton.textContent = `${level.level}`;
        levelButton.className = "level-button";

        if (level.level > highestUnlockedLevel) {
          levelButton.classList.add("locked");
          levelButton.disabled = true;
        } else {
          const handleSelect = (event) => {
            event.preventDefault();
            startLevel(level.level);
          };
          levelButton.addEventListener("click", handleSelect);
          levelButton.addEventListener("touchstart", handleSelect);
        }
        levelSelection.appendChild(levelButton);
      }
    };

    const startLevel = (levelNumber) => {
      levelSelection.style.display = "none";
      const gameCanvas = document.querySelector("#game");
      if (gameCanvas) {
        gameCanvas.style.display = "block";
      } else {
        return;
      }
      startGame(levelNumber);
    };

    // --- Event Listeners with Logging ---
    if (startButton) {
      startButton.addEventListener("click", (e) => {
        showLevelSelection(e);
      });
      startButton.addEventListener("touchstart", (e) => {
        showLevelSelection(e);
      });
    }

    if (exitButton) {
      const handleExit = (e) => {
        e.preventDefault();

        alert("Thanks for playing!");
      };
      exitButton.addEventListener("click", handleExit);
      exitButton.addEventListener("touchstart", handleExit);
    }
  </script>
</html>
